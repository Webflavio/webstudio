FROM node:20-bookworm-slim

# تعيين مجلد العمل
WORKDIR /app

# تثبيت pnpm عالميًا (الإصدار المستخدم في postinstall.sh)
RUN npm install -g pnpm@9.14.4

# نسخ ملفات التبعيات للاستفادة من الـ cache في Docker
COPY package.json pnpm-lock.yaml ./

# نسخ مجلد patches إذا كان موجودًا (حل لمشكلة ENOENT مع @stitches/react)
COPY patches ./patches

# تثبيت كل التبعيات (بما فيها devDependencies) لبناء التطبيق
RUN pnpm install --frozen-lockfile

# نسخ باقي الكود
COPY . .

# بناء التطبيق (يحتاج devDependencies مثل esbuild)
RUN pnpm build

# حذف node_modules وإعادة تثبيت التبعيات الإنتاجية فقط (للإنتاج)
RUN rm -rf node_modules pnpm-lock.yaml
COPY package.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile --prod

# تعريض المنفذ الرئيسي (بناءً على devcontainer.json)
EXPOSE 5173

# أمر التشغيل: تشغيل migrations ثم الخادم (غيّر 'start' إلى 'dev' إذا كان للتطوير)
CMD ["sh", "-c", "pnpm migrations migrate && pnpm start"]
